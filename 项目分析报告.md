# 项目分析报告

## 📋 项目概述

这是一个基于 **Next.js 16** 和 **React 19** 构建的现代化 Web 应用，主要用于**机器管理与任务调度系统**。项目采用 **Supabase** 作为后端数据库，实现了完整的用户认证、机器监控、任务管理等功能。

---

## 🏗️ 技术栈

### 前端技术
- **框架**: Next.js 16.0.3 (App Router)
- **UI 库**: React 19.2.0
- **语言**: TypeScript 5
- **样式**: Tailwind CSS v4 (使用 PostCSS)
- **UI 组件**: Radix UI (shadcn/ui 风格组件)
- **图标**: Lucide React
- **表单**: React Hook Form + Zod
- **通知**: Sonner
- **动画**: tw-animate-css

### 后端技术
- **数据库**: Supabase (PostgreSQL)
- **认证**: JWT (自定义实现) + bcryptjs
- **API**: Next.js API Routes
- **中间件**: Next.js Middleware

### 开发工具
- **包管理**: pnpm
- **代码质量**: ESLint
- **部署分析**: Vercel Analytics

---

## 📁 项目结构

```
Frontend/
├── app/                          # Next.js App Router 目录
│   ├── api/                      # API 路由
│   │   ├── auth/                 # 认证相关 API
│   │   │   ├── login/            # 登录接口
│   │   │   ├── logout/           # 登出接口
│   │   │   └── signup/           # 注册接口
│   │   ├── machines/             # 机器管理 API
│   │   └── user/                 # 用户管理 API
│   │       ├── bind-discord/     # 绑定 Discord
│   │       ├── change-password/  # 修改密码
│   │       └── extend/           # 延长账户
│   ├── dashboard/                # 仪表板页面
│   ├── tasks/                    # 任务管理页面
│   ├── machines/                 # 机器监控页面
│   ├── files/                    # 文件管理页面
│   ├── utilities/                # 工具页面
│   ├── history/                  # 历史记录页面
│   ├── login/                    # 登录页面
│   ├── signup/                   # 注册页面
│   ├── layout.tsx                # 根布局
│   ├── page.tsx                  # 首页（重定向逻辑）
│   └── globals.css               # 全局样式
├── components/                   # 共享组件
│   ├── ui/                       # UI 基础组件 (shadcn/ui)
│   ├── auth-guard.tsx            # 认证守卫组件
│   ├── dashboard-layout.tsx      # 仪表板布局
│   ├── dashboard-sidebar.tsx     # 侧边栏导航
│   ├── settings-dialog.tsx       # 设置对话框
│   └── theme-provider.tsx        # 主题提供者
├── hooks/                        # React Hooks
│   ├── use-mobile.ts             # 移动端检测
│   └── use-toast.ts              # 通知 Hook
├── lib/                          # 工具库
│   ├── auth.ts                   # JWT 认证工具
│   ├── supabase.ts               # Supabase 客户端
│   └── utils.ts                  # 通用工具函数
├── public/                       # 静态资源
├── middleware.ts                 # 中间件（路由保护）
├── next.config.mjs               # Next.js 配置
├── tsconfig.json                 # TypeScript 配置
└── package.json                  # 项目依赖
```

---

## 🔐 认证系统

### 认证流程

1. **登录流程**
   - 用户输入用户名和密码
   - 服务器验证凭证（bcrypt 密码哈希）
   - 检查账户状态（Active/Inactive）和过期时间
   - 生成 JWT Token（支持"记住我"功能，30天或2小时）
   - 设置 HttpOnly Cookie（`session_token`）
   - 自动生成/返回 API Key（如果不存在）

2. **注册流程**
   - 需要用户名、密码和 **License Key**
   - 验证 License Key 是否有效且未使用
   - 创建用户账户，设置过期时间（基于 License 天数）
   - 激活 License Key

3. **会话管理**
   - 使用 **JWT** 存储在 HttpOnly Cookie 中
   - 中间件验证每个请求的 Token
   - 支持 Token 过期检查
   - 客户端通过 `AuthGuard` 组件验证会话

### 安全特性

- ✅ 密码使用 bcrypt 哈希存储
- ✅ JWT Token 存储在 HttpOnly Cookie（防止 XSS）
- ✅ 服务器端 Token 验证
- ✅ 账户状态和过期时间检查
- ✅ 中间件路由保护
- ✅ 敏感数据（密码哈希、API Key）不返回客户端

---

## 🗄️ 数据库结构

### 主要数据表

#### 1. **users** (用户表)
- `id`: UUID (主键)
- `username`: 用户名 (唯一)
- `password_hash`: 密码哈希
- `plan`: 计划类型（天数）
- `status`: 账户状态 (Active/Inactive)
- `expires_at`: 过期时间
- `apikey`: API 密钥 (格式: `sk_xxxxxxxx`)
- `discord_id`: Discord ID (可选)
- `created_at`, `updated_at`: 时间戳

#### 2. **machines** (机器表)
- `id`: UUID (主键)
- `user_id`: 用户 ID (外键)
- `ip`: IP 地址
- `ram`: 内存大小
- `core`: CPU 核心数
- `status`: 状态 (Active/Inactive)
- `name`: 自定义名称 (可选)
- `last_heartbeat`: 最后心跳时间
- `created_at`, `updated_at`: 时间戳

#### 3. **licenses** (许可证表)
- `id`: UUID (主键)
- `license_key`: 许可证密钥 (唯一)
- `day`: 天数
- `status`: 状态 (Active/Inactive)
- `user_id`: 关联用户 ID
- `activated_at`: 激活时间

---

## 🎯 核心功能模块

### 1. **仪表板 (Dashboard)**
- 显示系统概览统计
- 活动任务数、在线机器数
- 系统运行时间和响应时间
- 最近活动记录

### 2. **任务管理 (Tasks)**
- 查看所有任务列表
- 任务状态：running、completed、pending
- 显示任务进度条
- 关联机器信息
- ⚠️ **注意**: 目前使用模拟数据，未连接真实后端

### 3. **机器管理 (Machines)**
- ✅ 实时获取用户的所有机器
- 显示机器信息：IP、内存、CPU 核心数
- 在线/离线状态标识
- 支持编辑机器名称（内联编辑）
- 最后心跳时间显示
- 空状态处理

### 4. **文件管理 (Files)**
- 文件/文件夹列表显示
- 上传功能入口
- ⚠️ **注意**: 目前使用模拟数据

### 5. **工具集 (Utilities)**
- 系统工具列表
- Terminal、Database Manager、Sync Tool 等
- ⚠️ **注意**: 目前为占位页面

### 6. **历史记录 (History)**
- 活动时间线显示
- 任务、文件、机器等操作记录
- ⚠️ **注意**: 目前使用模拟数据

### 7. **用户设置**
- 账户信息查看
- API Key 管理（显示/隐藏、复制）
- Discord ID 绑定
- 修改密码
- 账户延期（使用 License Key）
- 剩余天数显示

---

## 🔌 API 端点

### 认证 API
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `POST /api/auth/signup` - 用户注册

### 用户 API
- `GET /api/user` - 获取当前用户信息
- `POST /api/user/change-password` - 修改密码
- `POST /api/user/extend` - 延长账户（使用 License Key）
- `POST /api/user/bind-discord` - 绑定 Discord ID

### 机器 API
- `GET /api/machines` - 获取用户的机器列表
- `PATCH /api/machines` - 更新机器名称

---

## 🎨 UI/UX 特性

### 设计系统
- **主题**: 深色主题为主
- **颜色系统**: 使用 OKLCH 颜色空间
- **组件库**: shadcn/ui 风格的 Radix UI 组件
- **响应式**: 移动端适配（侧边栏可折叠）

### 用户体验
- ✅ 流畅的页面过渡动画
- ✅ 加载状态指示
- ✅ 错误处理和用户友好的错误提示
- ✅ Toast 通知系统
- ✅ 内联编辑功能
- ✅ 表单验证和错误提示

### 可访问性
- 使用 Radix UI 确保键盘导航和屏幕阅读器支持
- 语义化 HTML 结构

---

## 🔒 安全措施

### 已实现
1. ✅ JWT Token 存储在 HttpOnly Cookie
2. ✅ 密码使用 bcrypt 哈希
3. ✅ 中间件路由保护
4. ✅ 服务器端数据验证
5. ✅ 用户数据隔离（只能访问自己的机器）
6. ✅ API Key 唯一性验证
7. ✅ 账户状态和过期时间检查

### 建议改进
- ⚠️ 添加 CSRF 保护
- ⚠️ 实现速率限制（Rate Limiting）
- ⚠️ 添加密码强度要求
- ⚠️ 实现会话并发控制
- ⚠️ 添加操作日志记录

---

## ⚙️ 环境变量

项目需要以下环境变量：

```env
# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# 会话配置
SESSION_SECRET=your_session_secret_key
```

---

## 📝 代码质量

### 优点
- ✅ TypeScript 类型安全
- ✅ 组件化设计良好
- ✅ API 路由结构清晰
- ✅ 错误处理完善
- ✅ 代码注释清晰

### 待改进
- ⚠️ 缺少单元测试和集成测试
- ⚠️ 部分页面使用模拟数据（Tasks、Files、History）
- ⚠️ 缺少 API 文档
- ⚠️ 错误日志可以更详细
- ⚠️ 可以添加更多 TypeScript 类型定义

---

## 🚀 部署建议

### 推荐平台
- **Vercel** (Next.js 原生支持)
- **Netlify**
- **自托管** (Node.js 服务器)

### 部署前检查清单
- [ ] 设置所有必需的环境变量
- [ ] 配置 Supabase 数据库和 RLS 策略
- [ ] 确保 SESSION_SECRET 足够强
- [ ] 配置 CORS（如需要）
- [ ] 设置域名和 SSL 证书

---

## 🔄 待完成功能

### 高优先级
1. **任务管理后端集成** - 连接真实的数据库和任务系统
2. **文件上传功能** - 实现真实的文件存储（Supabase Storage）
3. **实时更新** - 机器状态和任务的实时更新（Supabase Realtime）
4. **操作历史记录** - 记录用户操作到数据库

### 中优先级
1. **任务创建/编辑/删除** - 完整的任务 CRUD 功能
2. **机器操作** - 重启、停止等机器控制功能
3. **通知系统** - 真实的通知系统集成
4. **数据可视化** - 图表和统计信息

### 低优先级
1. **多语言支持**
2. **主题切换**（深色/浅色）
3. **批量操作**
4. **导出功能**

---

## 📊 项目统计

- **页面数量**: 8 个主要页面
- **API 端点**: 9 个
- **组件数量**: 20+ UI 组件
- **依赖包**: 60+ npm 包
- **代码行数**: 约 3000+ 行

---

## 🎓 技术亮点

1. **自定义 JWT 实现** - 完整的 JWT 签名和验证（服务器端和 Edge）
2. **双重 Supabase 客户端** - 公共客户端和服务端客户端分离
3. **中间件路由保护** - 在 Edge Runtime 中验证 JWT
4. **类型安全的 API** - TypeScript 确保 API 请求/响应类型安全
5. **模块化组件设计** - 高度可复用的 UI 组件
6. **响应式布局** - 移动端和桌面端优化

---

## 📚 相关文档

- [Next.js 16 文档](https://nextjs.org/docs)
- [Supabase 文档](https://supabase.com/docs)
- [Tailwind CSS v4 文档](https://tailwindcss.com/docs)
- [Radix UI 文档](https://www.radix-ui.com/docs)

---

## 🐛 已知问题

1. **模拟数据** - Tasks、Files、History 页面使用硬编码数据
2. **Settings 页面缺失** - `/app/settings` 目录为空
3. **错误边界** - 缺少全局错误边界组件
4. **加载状态** - 某些页面可以改进加载体验

---

## 💡 建议和最佳实践

1. **测试覆盖** - 添加单元测试和集成测试
2. **API 文档** - 使用 OpenAPI/Swagger 生成 API 文档
3. **监控和日志** - 集成 Sentry 或类似服务
4. **性能优化** - 添加 React Query 进行数据缓存
5. **代码分割** - 优化大型组件的懒加载
6. **SEO** - 为公共页面添加元数据

---

*报告生成时间: 2024年*
*项目版本: 0.1.0*
